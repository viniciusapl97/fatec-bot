import logging
from datetime import date, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

from bot.db.base import SessionLocal
from bot.services import user_service, subject_service, activity_service

# Importa as fun√ß√µes de listagem de outros handlers para serem chamadas pelos bot√µes
from bot.handlers.subject_handler import list_subjects
from bot.handlers.activity_handler import list_activities
from bot.handlers.absence_handler import report_absences

logger = logging.getLogger(__name__)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Processa o /start, mostrando mensagem de boas-vindas e o novo menu principal aprimorado."""
    telegram_user = update.effective_user
    if update.callback_query:
        telegram_user = update.callback_query.from_user

    with SessionLocal() as db:
        user, is_new = user_service.get_or_create_user(
            db=db,
            user_id=telegram_user.id,
            first_name=telegram_user.first_name,
            username=telegram_user.username
        )

    if is_new:
        logger.info("Novo usu√°rio %s (ID: %s) iniciou o bot.", user.first_name, user.user_id)
        welcome_message = (
            f"Ol√°, {user.first_name}! Bem-vindo(a) ao seu novo assistente de estudos. üöÄ\n\n"
            "A jornada para a excel√™ncia come√ßa com organiza√ß√£o, e eu estou aqui para te ajudar a trilhar o caminho rumo √† aprova√ß√£o!\n\n"
            "Use os bot√µes abaixo para navegar por todas as minhas funcionalidades."
        )
    else:
        logger.info("Usu√°rio %s (ID: %s) retornou.", user.first_name, user.user_id)
        welcome_message = f"Ol√° de volta, {user.first_name}! üëã\n\nO que vamos organizar hoje?"

    keyboard = [
        [
            InlineKeyboardButton("‚òÄÔ∏è Resumo de Hoje", callback_data="summary_today"),
            InlineKeyboardButton("üóìÔ∏è Resumo da Semana", callback_data="summary_week")
        ],
        [
            InlineKeyboardButton("üìö Mat√©rias", callback_data="menu_subjects"),
            InlineKeyboardButton("üóìÔ∏è Trabalhos e Provas", callback_data="menu_activities")
        ],
        [
            InlineKeyboardButton("‚úñÔ∏è Faltas", callback_data="menu_absences"),
            InlineKeyboardButton("üéì Notas", callback_data="menu_grades")
        ],
        [InlineKeyboardButton("‚ùì Ajuda", callback_data="main_help")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text(text=welcome_message, reply_markup=reply_markup, parse_mode='HTML')
    else:
        await update.message.reply_html(text=welcome_message, reply_markup=reply_markup)


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Processa os cliques nos bot√µes, agindo como um roteador para os menus."""
    query = update.callback_query
    data = query.data

    if data == "main_menu":
        await start(update, context)
        return

    # --- Sub-Menus ---
    elif data == "menu_subjects":
        keyboard = [
            [InlineKeyboardButton("üìñ Ver Grade Hor√°ria", callback_data="main_grade")],
            [InlineKeyboardButton("‚ûï Adicionar Mat√©ria", callback_data="start_new_subject")],
            [InlineKeyboardButton("‚öôÔ∏è Gerenciar Mat√©rias", callback_data="start_manage_subjects")],
            [InlineKeyboardButton("¬´ Voltar ao Menu Principal", callback_data="main_menu")]
        ]
        await query.edit_message_text("üìö *Mat√©rias*\n\nO que deseja fazer?", reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')

    elif data == "menu_activities":
        keyboard = [
            [InlineKeyboardButton("üìÖ Ver Calend√°rio Completo", callback_data="main_agenda")],
            [
                InlineKeyboardButton("üìù Add Trabalho", callback_data="start_new_activity_trabalho"),
                InlineKeyboardButton("‚ùóÔ∏è Add Prova", callback_data="start_new_activity_prova")
            ],
            [
                InlineKeyboardButton("‚öôÔ∏è Gerenciar Trabalhos", callback_data="start_manage_trabalhos"),
                InlineKeyboardButton("‚öôÔ∏è Gerenciar Provas", callback_data="start_manage_provas")
            ],
            [InlineKeyboardButton("¬´ Voltar ao Menu Principal", callback_data="main_menu")]
        ]
        await query.edit_message_text("üóìÔ∏è *Trabalhos e Provas*\n\nO que deseja fazer?", reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')
        
    elif data == "menu_absences":
        keyboard = [
            [InlineKeyboardButton("‚ûï Registrar Falta", callback_data="start_new_absence")],
            [InlineKeyboardButton("‚öôÔ∏è Gerenciar Faltas", callback_data="start_manage_absences")],
            [InlineKeyboardButton("üìä Ver Relat√≥rio de Faltas", callback_data="report_absences_action")],
            [InlineKeyboardButton("¬´ Voltar ao Menu Principal", callback_data="main_menu")]
        ]
        await query.edit_message_text("‚úñÔ∏è *Faltas*\n\nO que deseja fazer?", reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')

    elif data == "menu_grades":
        keyboard = [
            [InlineKeyboardButton("‚ûï Lan√ßar Nota", callback_data="start_new_grade")],
            # [InlineKeyboardButton("‚öôÔ∏è Gerenciar Notas", callback_data="start_manage_grades")], # Descomentado quando implementado
            [InlineKeyboardButton("¬´ Voltar ao Menu Principal", callback_data="main_menu")]
        ]
        await query.edit_message_text("üéì *Notas*\n\nO que deseja fazer?", reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')
    
    # --- A√ß√µes Diretas ---
    elif data == "summary_today":
        await today_command(update, context)
    elif data == "summary_week":
        await week_command(update, context)
    elif data == "main_grade":
        await list_subjects(update, context)
    elif data == "main_agenda":
        await list_activities(update, context)
    elif data == "report_absences_action":
        await report_absences(update, context)
    elif data == "main_help":
        await help_command(update, context)


async def today_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Exibe um resumo do dia, respondendo a um comando ou editando uma mensagem de bot√£o."""
    query = update.callback_query
    if query:
        await query.answer()
        telegram_user = query.from_user
    else:
        telegram_user = update.effective_user
    
    today = date.today()
    weekday_map = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"]
    today_weekday_name = weekday_map[today.weekday()]
    message = f"‚òÄÔ∏è *Resumo para hoje, {today.strftime('%d/%m/%Y')} ({today_weekday_name})*:\n\n"
    
    with SessionLocal() as db:
        user, _ = user_service.get_or_create_user(db, telegram_user.id, telegram_user.first_name, telegram_user.username)
        todays_subjects = subject_service.get_subjects_by_day_of_week(db, user, today_weekday_name)
        message += "üìö *Aulas de Hoje:*\n"
        if not todays_subjects:
            message += "   - Nenhuma aula hoje. Aproveite!\n"
        else:
            for subject in todays_subjects:
                start_str = subject.start_time.strftime('%H:%M') if subject.start_time else '--:--'
                end_str = subject.end_time.strftime('%H:%M') if subject.end_time else '--:--'
                message += f"   ‚Ä¢ `{start_str}`-`{end_str}`: *{subject.name}* (Sala: {subject.room})\n"
        
        message += "\n" + "‚Äî" * 20 + "\n\n"

        todays_activities = activity_service.get_activities_by_date(db, user, today)
        message += "üìå *Entregas e Provas para Hoje:*\n"
        if not todays_activities:
            message += "   - Nenhuma entrega ou prova agendada para hoje!\n"
        else:
            for activity in todays_activities:
                icon = "üìù" if activity.activity_type == 'trabalho' else "‚ùóÔ∏è"
                message += f"   {icon} *{activity.name}* (Mat√©ria: {activity.subject.name})\n"

    if query:
        await query.edit_message_text(message, parse_mode='HTML')
    else:
        await update.message.reply_html(message)


async def week_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Exibe as atividades da semana, respondendo a um comando ou editando uma mensagem de bot√£o."""
    query = update.callback_query
    if query:
        await query.answer()
        telegram_user = query.from_user
    else:
        telegram_user = update.effective_user

    today = date.today()
    end_of_week = today + timedelta(days=6)
    message = f"üóìÔ∏è *Agenda para os pr√≥ximos 7 dias (de {today.strftime('%d/%m')} a {end_of_week.strftime('%d/%m')})*:\n\n"
    
    with SessionLocal() as db:
        user, _ = user_service.get_or_create_user(db, telegram_user.id, telegram_user.first_name, telegram_user.username)
        week_activities = activity_service.get_activities_by_date_range(db, user, today, end_of_week)

        if not week_activities:
            message += "Nenhuma atividade agendada para esta semana. Que tranquilidade!"
        else:
            for activity in week_activities:
                icon = "üìù" if activity.activity_type == 'trabalho' else "‚ùóÔ∏è"
                message += f" ‚Ä¢ *{activity.due_date.strftime('%d/%m (%a)')}:* {icon} {activity.name} ({activity.subject.name})\n"

    if query:
        await query.edit_message_text(message, parse_mode='HTML')
    else:
        await update.message.reply_html(message)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Envia uma mensagem de ajuda completa e estruturada."""
    query = update.callback_query
    if query:
        await query.answer()

    help_text = (
        "Ol√°! Eu sou seu assistente de estudos. Aqui est√° um resumo de tudo que posso fazer:\n\n"
        "üí° **Dica Principal:** A melhor forma de me usar √© atrav√©s do menu interativo. "
        "Basta enviar /start para acess√°-lo a qualquer momento!\n\n"
        "Aqui est√£o os comandos diretos, organizados por categoria:\n\n"
        "‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî\n\n"
        "üìö *Mat√©rias*\n"
        "‚Ä¢ /grade - Exibe sua grade hor√°ria completa.\n"
        "‚Ä¢ /addmateria - Inicia o cadastro de uma nova mat√©ria.\n"
        "‚Ä¢ /gerenciarmaterias - Permite editar ou excluir mat√©rias existentes.\n\n"
        
        "üóìÔ∏è *Trabalhos e Provas*\n"
        "‚Ä¢ /calendario - Lista todos os seus trabalhos e provas.\n"
        "‚Ä¢ /addtrabalho - Adiciona um novo trabalho na sua agenda.\n"
        "‚Ä¢ /addprova - Adiciona uma nova prova na sua agenda.\n"
        "‚Ä¢ /gerenciartrabalhos - Permite editar ou excluir trabalhos.\n"
        "‚Ä¢ /gerenciarprovas - Permite editar ou excluir provas.\n\n"

        "‚úñÔ∏è *Faltas e üéì Notas*\n"
        "‚Ä¢ /faltei - Registra uma ou mais faltas em uma mat√©ria.\n"
        "‚Ä¢ /gerenciarfaltas - Edita ou exclui o total de faltas de uma mat√©ria.\n"
        "‚Ä¢ /addnota - Lan√ßa uma nova nota para uma mat√©ria.\n\n"
        
        "‚ö° *Resumos R√°pidos*\n"
        "‚Ä¢ /hoje - Mostra um resumo das aulas e atividades do dia.\n"
        "‚Ä¢ /semana - Lista as atividades dos pr√≥ximos 7 dias.\n"
        "‚Ä¢ /relatorio - Gera um relat√≥rio detalhado de uma mat√©ria.\n\n"
        
        "‚öôÔ∏è *Comandos Gerais*\n"
        "‚Ä¢ /start - Inicia o bot e mostra o menu principal.\n"
        "‚Ä¢ /help - Mostra esta mensagem de ajuda.\n"
        "‚Ä¢ /cancelar - *(Importante!)* Interrompe qualquer opera√ß√£o em andamento."
    )
    
    if query:
        await query.edit_message_text(help_text, parse_mode='HTML')
    else:
        await update.message.reply_html(help_text)